Index: Filter/Template/SignatureProvider.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/vendor/magento/framework/Filter/Template/SignatureProvider.php b/vendor/magento/framework/Filter/Template/SignatureProvider.php
new file mode 100644
--- /dev/null
+++ b/vendor/magento/framework/Filter/Template/SignatureProvider.php
@@ -0,0 +1,53 @@
+<?php
+/**
+ * Copyright © Magento, Inc. All rights reserved.
+ * See COPYING.txt for license details.
+ */
+declare(strict_types=1);
+
+namespace Magento\Framework\Filter\Template;
+
+/**
+ * Provider of a signature.
+ *
+ * Provides a signature which should be used to sign deferred directives
+ * (directives that should be processed in scope of a parent template
+ * instead of own scope, e.g. {{inlinecss}}).
+ */
+class SignatureProvider
+{
+    /**
+     * @var string|null
+     */
+    private $signature;
+
+    /**
+     * @var \Magento\Framework\Math\Random
+     */
+    private $random;
+
+    /**
+     * @param \Magento\Framework\Math\Random $random
+     */
+    public function __construct(
+        \Magento\Framework\Math\Random $random
+    ) {
+        $this->random = $random;
+    }
+
+    /**
+     * Generates a random string which will be used as a signature during runtime.
+     *
+     * @return string
+     *
+     * @throws \Magento\Framework\Exception\LocalizedException
+     */
+    public function get(): string
+    {
+        if ($this->signature === null) {
+            $this->signature = $this->random->getRandomString(32);
+        }
+
+        return $this->signature;
+    }
+}
Index: Filter/Template/vendor/magento/framework/FilteringDepthMeter.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/vendor/magento/framework/Filter/Template/vendor/magento/framework/FilteringDepthMeter.php b/vendor/magento/framework/Filter/Template/vendor/magento/framework/FilteringDepthMeter.php
new file mode 100644
--- /dev/null
+++ b/vendor/magento/framework/Filter/Template/vendor/magento/framework/FilteringDepthMeter.php
@@ -0,0 +1,52 @@
+<?php
+/**
+ * Copyright © Magento, Inc. All rights reserved.
+ * See COPYING.txt for license details.
+ */
+declare(strict_types=1);
+
+namespace Magento\Framework\Filter\Template;
+
+/**
+ * Meter of template filtering depth.
+ *
+ * Records and provides template/directive filtering depth (filtering recursion).
+ * Filtering depth 1 means that template or directive is root and has no parents.
+ */
+class FilteringDepthMeter
+{
+    /**
+     * @var int
+     */
+    private $depth = 0;
+
+    /**
+     * Increases filtering depth.
+     *
+     * @return void
+     */
+    public function descend()
+    {
+        $this->depth++;
+    }
+
+    /**
+     * Decreases filtering depth.
+     *
+     * @return void
+     */
+    public function ascend()
+    {
+        $this->depth--;
+    }
+
+    /**
+     * Shows current filtering depth.
+     *
+     * @return int
+     */
+    public function showMark(): int
+    {
+        return $this->depth;
+    }
+}
Index: Filter/Template.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/vendor/magento/framework/Filter/Template.php b/vendor/magento/framework/Filter/Template.php
--- a/vendor/magento/framework/Filter/Template.php
+++ b/vendor/magento/framework/Filter/Template.php	(date 1665693664575)
@@ -9,6 +9,7 @@
  */
 namespace Magento\Framework\Filter;

+use InvalidArgumentException;
 use Magento\Framework\App\ObjectManager;
 use Magento\Framework\Filter\DirectiveProcessor\DependDirective;
 use Magento\Framework\Filter\DirectiveProcessor\ForDirective;
@@ -17,6 +18,8 @@
 use Magento\Framework\Filter\DirectiveProcessor\TemplateDirective;
 use Magento\Framework\Filter\DirectiveProcessor\VarDirective;
 use Magento\Framework\Stdlib\StringUtils;
+use Magento\Framework\Filter\Template\SignatureProvider;
+use Magento\Framework\Filter\Template\FilteringDepthMeter;

 /**
  * Template filter
@@ -32,37 +35,39 @@
      *
      * @deprecated Use the new Directive processors
      */
-    const CONSTRUCTION_PATTERN = '/{{([a-z]{0,10})(.*?)}}(?:(.*?)(?:{{\/(?:\\1)}}))?/si';
+    public const CONSTRUCTION_PATTERN = '/{{([a-z]{0,10})(.*?)}}(?:(.*?)(?:{{\/(?:\\1)}}))?/si';

     /**
      * Construction `depend` regular expression
      *
      * @deprecated Use the new Directive processors
      */
-    const CONSTRUCTION_DEPEND_PATTERN = '/{{depend\s*(.*?)}}(.*?){{\\/depend\s*}}/si';
+    public const CONSTRUCTION_DEPEND_PATTERN = '/{{depend\s*(.*?)}}(.*?){{\\/depend\s*}}/si';

     /**
      * Construction `if` regular expression
      *
      * @deprecated Use the new Directive processors
      */
-    const CONSTRUCTION_IF_PATTERN = '/{{if\s*(.*?)}}(.*?)({{else}}(.*?))?{{\\/if\s*}}/si';
+    public const CONSTRUCTION_IF_PATTERN = '/{{if\s*(.*?)}}(.*?)({{else}}(.*?))?{{\\/if\s*}}/si';

     /**
      * Construction `template` regular expression
      *
      * @deprecated Use the new Directive processors
      */
-    const CONSTRUCTION_TEMPLATE_PATTERN = '/{{(template)(.*?)}}/si';
+    public const CONSTRUCTION_TEMPLATE_PATTERN = '/{{(template)(.*?)}}/si';

     /**
      * Construction `for` regular expression
      *
      * @deprecated Use the new Directive processors
      */
-    const LOOP_PATTERN = '/{{for(?P<loopItem>.*? )(in)(?P<loopData>.*?)}}(?P<loopBody>.*?){{\/for}}/si';
+    public const LOOP_PATTERN = '/{{for(?P<loopItem>.*? )(in)(?P<loopData>.*?)}}(?P<loopBody>.*?){{\/for}}/si';

-    /**#@-*/
+    /**
+     * @var array
+     */
     private $afterFilterCallbacks = [];

     /**
@@ -73,8 +78,6 @@
     protected $templateVars = [];

     /**
-     * Template processor
-     *
      * @var callable|null
      */
     protected $templateProcessor = null;
@@ -99,17 +102,31 @@
      */
     private $variableResolver;

+    /**
+     * @var SignatureProvider|null
+     */
+    private $signatureProvider;
+
+    /**
+     * @var FilteringDepthMeter|null
+     */
+    private $filteringDepthMeter;
+
     /**
      * @param StringUtils $string
      * @param array $variables
      * @param DirectiveProcessorInterface[] $directiveProcessors
      * @param VariableResolverInterface|null $variableResolver
+     * @param SignatureProvider|null $signatureProvider
+     * @param FilteringDepthMeter|null $filteringDepthMeter
      */
     public function __construct(
         StringUtils $string,
-        $variables = [],
-        $directiveProcessors = [],
-        VariableResolverInterface $variableResolver = null
+                    $variables = [],
+                    $directiveProcessors = [],
+        VariableResolverInterface $variableResolver = null,
+        SignatureProvider $signatureProvider = null,
+        FilteringDepthMeter $filteringDepthMeter = null
     ) {
         $this->string = $string;
         $this->setVariables($variables);
@@ -117,6 +134,12 @@
         $this->variableResolver = $variableResolver ?? ObjectManager::getInstance()
                 ->get(VariableResolverInterface::class);

+        $this->signatureProvider = $signatureProvider ?? ObjectManager::getInstance()
+                ->get(SignatureProvider::class);
+
+        $this->filteringDepthMeter = $filteringDepthMeter ?? ObjectManager::getInstance()
+                ->get(FilteringDepthMeter::class);
+
         if (empty($directiveProcessors)) {
             $this->directiveProcessors = [
                 'depend' => ObjectManager::getInstance()->get(DependDirective::class),
@@ -172,25 +195,125 @@
      */
     public function filter($value)
     {
+        if (!is_string($value)) {
+            throw new InvalidArgumentException(__(
+                'Argument \'value\' must be type of string, %1 given.',
+                gettype($value)
+            )->render());
+        }
+
+        $this->filteringDepthMeter->descend();
+
+        // Processing of template directives.
+        $templateDirectivesResults = $this->processDirectives($value);
+
+        foreach ($templateDirectivesResults as $result) {
+            $value = str_replace($result['directive'], $result['output'], $value);
+        }
+
+        // Processing of deferred directives received from child templates
+        // or nested directives.
+        $deferredDirectivesResults = $this->processDirectives($value, true);
+
+        foreach ($deferredDirectivesResults as $result) {
+            $value = str_replace($result['directive'], $result['output'], $value);
+        }
+
+        if ($this->filteringDepthMeter->showMark() > 1) {
+            // Signing own deferred directives (if any).
+            $signature = $this->signatureProvider->get();
+
+            foreach ($templateDirectivesResults as $result) {
+                if ($result['directive'] === $result['output']) {
+                    $value = str_replace(
+                        $result['output'],
+                        $signature . $result['output'] . $signature,
+                        $value
+                    );
+                }
+            }
+        }
+
+        $value = $this->afterFilter($value);
+
+        $this->filteringDepthMeter->ascend();
+
+        return $value;
+    }
+
+    /**
+     * Processes template directives and returns an array that contains results produced by each directive.
+     *
+     * @param string $value
+     * @param bool $isSigned
+     *
+     * @return array
+     *
+     * @throws InvalidArgumentException
+     * @throws \Magento\Framework\Exception\LocalizedException
+     */
+    private function processDirectives($value, $isSigned = false): array
+    {
+        $results = [];
+
         foreach ($this->directiveProcessors as $directiveProcessor) {
             if (!$directiveProcessor instanceof DirectiveProcessorInterface) {
-                throw new \InvalidArgumentException(
+                throw new InvalidArgumentException(
                     'Directive processors must implement ' . DirectiveProcessorInterface::class
                 );
             }

-            if (preg_match_all($directiveProcessor->getRegularExpression(), $value, $constructions, PREG_SET_ORDER)) {
+            $pattern = $directiveProcessor->getRegularExpression();
+
+            if ($isSigned) {
+                $pattern = $this->embedSignatureIntoPattern($pattern);
+            }
+
+            if (preg_match_all($pattern, $value, $constructions, PREG_SET_ORDER)) {
                 foreach ($constructions as $construction) {
                     $replacedValue = $directiveProcessor->process($construction, $this, $this->templateVars);

-                    $value = str_replace($construction[0], $replacedValue, $value);
+                    $results[] = [
+                        'directive' => $construction[0],
+                        'output' => $replacedValue
+                    ];
                 }
             }
         }
+
+        return $results;
+    }

-        $value = $this->afterFilter($value);
+    /**
+     * Modifies given regular expression pattern to be able to recognize signed directives.
+     *
+     * @param string $pattern
+     *
+     * @return string
+     *
+     * @throws \Magento\Framework\Exception\LocalizedException
+     */
+    private function embedSignatureIntoPattern(string $pattern): string
+    {
+        $signature = $this->signatureProvider->get();
+
+        $closingDelimiters = [
+            '(' => ')',
+            '{' => '}',
+            '[' => ']',
+            '<' => '>'
+        ];

-        return $value;
+        $closingDelimiter = $openingDelimiter = substr(trim($pattern), 0, 1);
+
+        if (array_key_exists($openingDelimiter, $closingDelimiters)) {
+            $closingDelimiter = $closingDelimiters[$openingDelimiter];
+        }
+
+        $pattern = substr_replace($pattern, $signature, strpos($pattern, $openingDelimiter) + 1, 0);
+        $pattern = substr_replace($pattern, $signature, strrpos($pattern, $closingDelimiter), 0);
+
+        return $pattern;
     }

     /**
@@ -246,11 +369,12 @@
      * @param string[] $construction
      * @return string
      * @deprecated 102.0.4 Use the directive interfaces instead
+     * @see \Magento\Framework\Filter\DirectiveProcessorInterface
      */
     public function varDirective($construction)
     {
         $directive = $this->directiveProcessors['var'] ?? ObjectManager::getInstance()
-            ->get(VarDirective::class);
+                ->get(VarDirective::class);

         return $directive->process($construction, $this, $this->templateVars);
     }
@@ -261,14 +385,15 @@
      * @param string[] $construction
      * @return string
      * @deprecated 102.0.4 Use the directive interfaces instead
+     * @see \Magento\Framework\Filter\DirectiveProcessorInterface
      * @since 102.0.4
      */
     public function forDirective($construction)
     {
         $directive = $this->directiveProcessors['for'] ?? ObjectManager::getInstance()
-            ->get(ForDirective::class);
+                ->get(ForDirective::class);

-        preg_match($directive->getRegularExpression(), $construction[0], $specificConstruction);
+        preg_match($directive->getRegularExpression(), $construction[0] ?? '', $specificConstruction);

         return $directive->process($specificConstruction, $this, $this->templateVars);
     }
@@ -286,11 +411,12 @@
      * @param string[] $construction
      * @return mixed
      * @deprecated 102.0.4 Use the directive interfaces instead
+     * @see \Magento\Framework\Filter\DirectiveProcessorInterface
      */
     public function templateDirective($construction)
     {
         $directive = $this->directiveProcessors['template'] ?? ObjectManager::getInstance()
-            ->get(TemplateDirective::class);
+                ->get(TemplateDirective::class);

         return $directive->process($construction, $this, $this->templateVars);
     }
@@ -301,13 +427,14 @@
      * @param string[] $construction
      * @return string
      * @deprecated 102.0.4 Use the directive interfaces instead
+     * @see \Magento\Framework\Filter\DirectiveProcessorInterface
      */
     public function dependDirective($construction)
     {
         $directive = $this->directiveProcessors['depend'] ?? ObjectManager::getInstance()
-            ->get(DependDirective::class);
+                ->get(DependDirective::class);

-        preg_match($directive->getRegularExpression(), $construction[0], $specificConstruction);
+        preg_match($directive->getRegularExpression(), $construction[0] ?? '', $specificConstruction);

         return $directive->process($specificConstruction, $this, $this->templateVars);
     }
@@ -318,13 +445,14 @@
      * @param string[] $construction
      * @return string
      * @deprecated 102.0.4 Use the directive interfaces instead
+     * @see \Magento\Framework\Filter\DirectiveProcessorInterface
      */
     public function ifDirective($construction)
     {
         $directive = $this->directiveProcessors['if'] ?? ObjectManager::getInstance()
-            ->get(IfDirective::class);
+                ->get(IfDirective::class);

-        preg_match($directive->getRegularExpression(), $construction[0], $specificConstruction);
+        preg_match($directive->getRegularExpression(), $construction[0] ?? '', $specificConstruction);

         return $directive->process($specificConstruction, $this, $this->templateVars);
     }
@@ -335,6 +463,7 @@
      * @param string $value raw parameters
      * @return array
      * @deprecated 102.0.4 Use the directive interfaces instead
+     * @see \Magento\Framework\Filter\DirectiveProcessorInterface
      */
     protected function getParameters($value)
     {
@@ -342,7 +471,7 @@
         $tokenizer->setString($value);
         $params = $tokenizer->tokenize();
         foreach ($params as $key => $value) {
-            if (substr($value, 0, 1) === '$') {
+            if ($value !== null && substr($value, 0, 1) === '$') {
                 $params[$key] = $this->getVariable(substr($value, 1), null);
             }
         }
@@ -356,6 +485,7 @@
      * @param string $default default value
      * @return string
      * @deprecated 102.0.4 Use \Magento\Framework\Filter\VariableResolverInterface instead
+     * @see \Magento\Framework\Filter\VariableResolverInterface
      */
     protected function getVariable($value, $default = '{no_value_defined}')
     {
@@ -372,13 +502,14 @@
      * @param array $stack
      * @return array
      * @deprecated 102.0.4 Use new directive processor interfaces
+     * @see \Magento\Framework\Filter\DirectiveProcessorInterface
      */
     protected function getStackArgs($stack)
     {
         foreach ($stack as $i => $value) {
             if (is_array($value)) {
                 $stack[$i] = $this->getStackArgs($value);
-            } elseif (substr($value, 0, 1) === '$') {
+            } elseif ($value !== null && substr($value, 0, 1) === '$') {
                 $stack[$i] = $this->getVariable(substr($value, 1), null);
             }
         }
@@ -399,6 +530,8 @@
      * @param bool $strictMode Enable strict parsing of directives
      * @return bool The previous mode from before the change
      * @since 102.0.4
+     * @deprecated The method is not in use anymore.
+     * @see https://developer.adobe.com/commerce/frontend-core/guide/templates/email-migration/#remove-the-legacy-variable-resolver
      */
     public function setStrictMode(bool $strictMode): bool
     {
@@ -413,6 +546,8 @@
      *
      * @return bool
      * @since 102.0.4
+     * @deprecated The method is not in use anymore.
+     * @see https://developer.adobe.com/commerce/frontend-core/guide/templates/email-migration/#remove-the-legacy-variable-resolver
      */
     public function isStrictMode(): bool
     {
